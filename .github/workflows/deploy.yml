name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necessÃ¡rios:
#   FTP_SERVER   â†’ sh00180.hostgator.com.br
#   FTP_USERNAME â†’ abdonc73
#   FTP_PASSWORD â†’ senha principal do cPanel

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: ğŸšš Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ˜ Setup PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, json, tokenizer, pdo, pdo_mysql, curl, openssl, bcmath, zip

    - name: ğŸ’¾ Cache do vendor/
      uses: actions/cache@v4
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}
        restore-keys: composer-

    - name: ğŸ“¦ Instalar dependÃªncias PHP
      run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

    - name: ğŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ğŸ”¨ Compilar assets CSS/JS
      run: |
        npm ci
        npm run build

    - name: ğŸ“¤ Commit vendor/ e assets no repositÃ³rio
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add vendor/ public/build/
        git diff --staged --quiet || git commit -m "chore: vendor e assets compilados [skip ci]"
        git push origin HEAD:main || true

    - name: ğŸš€ Deploy via API cPanel
      env:
        CPANEL_USER: ${{ secrets.FTP_USERNAME }}
        CPANEL_PASS: ${{ secrets.FTP_PASSWORD }}
        CPANEL_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        echo "Disparando deploy no cPanel..."
        RESPONSE=$(curl -sk -u "$CPANEL_USER:$CPANEL_PASS" \
          "https://$CPANEL_HOST:2083/execute/VersionControlDeployment/create?repository_root=/home1/$CPANEL_USER/repositories/iagus")
        echo "Resposta: $RESPONSE"
        if echo "$RESPONSE" | grep -q '"status":0'; then
          echo "âŒ Erro no deploy cPanel"
          exit 1
        fi
        echo "âœ… Deploy disparado â€” cPanel irÃ¡ puxar repo (com vendor/) e rodar artisan"

