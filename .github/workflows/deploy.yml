name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necess√°rios:
#   FTP_SERVER   ‚Üí sh00180.hostgator.com.br
#   FTP_USERNAME ‚Üí abdonc73
#   FTP_PASSWORD ‚Üí senha principal do cPanel

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üöö Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üî® Compilar assets CSS/JS
      run: |
        npm ci
        npm run build

    - name: üì§ Commit assets compilados ao reposit√≥rio
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add public/build/
        git diff --staged --quiet || git commit -m "chore: compilar assets [skip ci]"
        git push origin HEAD:main || true

    - name: üöÄ Deploy via API cPanel (pull + .cpanel.yml)
      env:
        CPANEL_USER: ${{ secrets.FTP_USERNAME }}
        CPANEL_PASS: ${{ secrets.FTP_PASSWORD }}
        CPANEL_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        echo "Disparando deploy no cPanel..."
        RESPONSE=$(curl -sk -u "$CPANEL_USER:$CPANEL_PASS" \
          "https://$CPANEL_HOST:2083/execute/VersionControlDeployment/create?repository_root=/home1/$CPANEL_USER/repositories/iagus")
        echo "Resposta: $RESPONSE"
        if echo "$RESPONSE" | grep -q '"status":0'; then
          echo "‚ùå Erro no deploy cPanel"
          echo "$RESPONSE" | python3 -c "import sys,json; d=json.load(sys.stdin); [print(e) for e in d.get('errors',[])]" || true
          exit 1
        fi
        echo "‚úÖ Deploy disparado com sucesso!"
        echo "O cPanel est√° rodando: composer install + migrate + optimize"
        echo "Acompanhe em: https://$CPANEL_HOST:2083 ‚Üí Git ‚Üí Implementa√ß√µes"

