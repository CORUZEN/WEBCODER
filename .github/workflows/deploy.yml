name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necess√°rios:
#   FTP_SERVER   ‚Üí sh00180.hostgator.com.br
#   FTP_USERNAME ‚Üí abdonc73
#   FTP_PASSWORD ‚Üí senha principal do cPanel

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
    - name: üöö Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: üêò Setup PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, json, tokenizer, pdo, pdo_mysql, curl, openssl, bcmath, zip

    - name: üíæ Cache do vendor/
      uses: actions/cache@v4
      with:
        path: vendor
        key: composer-${{ hashFiles('composer.lock') }}
        restore-keys: composer-

    - name: üì¶ Instalar depend√™ncias PHP
      run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

    - name: üì¶ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üî® Compilar assets CSS/JS
      run: |
        npm ci
        npm run build

    - name: üì§ Commit vendor/ e assets no reposit√≥rio
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add vendor/ public/build/
        git diff --staged --quiet || git commit -m "chore: vendor e assets compilados [skip ci]"
        git push origin HEAD:main || true

    - name: üöÄ Deploy via API cPanel
      env:
        CPANEL_USER: ${{ secrets.FTP_USERNAME }}
        CPANEL_PASS: ${{ secrets.FTP_PASSWORD }}
        CPANEL_HOST: ${{ secrets.FTP_SERVER }}
      run: |
        # Tentar ambos os paths (iagus ou IAGUS) - depende de como o cPanel criou
        for REPO_NAME in IAGUS iagus; do
          REPO_ROOT="/home1/$CPANEL_USER/repositories/$REPO_NAME"

          echo "1Ô∏è‚É£  Tentando pull em $REPO_ROOT..."
          PULL=$(curl -sk -u "$CPANEL_USER:$CPANEL_PASS" \
            "https://$CPANEL_HOST:2083/execute/VersionControl/update?repository_root=$REPO_ROOT")
          echo "Pull: $PULL"

          if echo "$PULL" | grep -q '"errors":null'; then
            echo "‚úÖ Pull OK em $REPO_ROOT"
            break
          fi
        done

        echo "Aguardando 5s para o pull completar..."
        sleep 5

        echo "2Ô∏è‚É£  Implementar HEAD (.cpanel.yml tasks)..."
        DEPLOY=$(curl -sk -u "$CPANEL_USER:$CPANEL_PASS" \
          "https://$CPANEL_HOST:2083/execute/VersionControlDeployment/create?repository_root=$REPO_ROOT")
        echo "Deploy: $DEPLOY"

        if echo "$DEPLOY" | grep -q '"status":0'; then
          echo "‚ùå Erro no deploy cPanel"
          exit 1
        fi
        echo "‚úÖ Deploy completo ‚Äî cPanel puxou repo e rodou artisan automaticamente"

