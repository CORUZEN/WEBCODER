name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necessÃ¡rios (apenas 4):
#   FTP_SERVER   â†’ 69.6.249.117
#   FTP_USERNAME â†’ abdonc73
#   FTP_PASSWORD â†’ senha principal do cPanel
#   REMOTE_PATH  â†’ /home1/abdonc73/iagus.com.br

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”¨ Instalar dependÃªncias e compilar assets
      run: |
        npm ci
        npm run build

    - name: ðŸ“‚ Deploy via SFTP (porta 2222)
      uses: wlixcc/SFTP-Deploy-Action@v1.2.4
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 2222
        local_path: './*'
        remote_path: ${{ secrets.REMOTE_PATH }}
        sftp_only: true
        delete_remote_files: false
        args: '-o ConnectTimeout=30 -o StrictHostKeyChecking=no'
        sftpargs: '--exclude=.git --exclude=node_modules --exclude=.env --exclude=storage/logs --exclude=storage/framework/cache --exclude=storage/framework/sessions --exclude=storage/framework/views'

    - name: ðŸš€ PÃ³s-deploy via SSH (composer, migrate, optimize)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 2222
        script: |
          cd ${{ secrets.REMOTE_PATH }}
          /usr/local/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction
          /usr/local/bin/php artisan migrate --force
          /usr/local/bin/php artisan optimize:clear
          /usr/local/bin/php artisan optimize
          /usr/local/bin/php artisan storage:link --relative 2>/dev/null || true
          chmod -R 775 storage bootstrap/cache
          echo "âœ… Deploy concluÃ­do!"
