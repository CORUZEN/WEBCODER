name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necess√°rios:
#   FTP_SERVER   ‚Üí sh00180.hostgator.com.br
#   FTP_USERNAME ‚Üí abdonc73
#   FTP_PASSWORD ‚Üí senha principal do cPanel
#   REMOTE_PATH  ‚Üí /home1/abdonc73/iagus.com.br

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: üöö Checkout code
      uses: actions/checkout@v4

    - name: üêò Setup PHP 8.3
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.3'
        extensions: mbstring, xml, ctype, json, tokenizer, pdo, pdo_mysql, curl, openssl, bcmath, zip

    - name: üì¶ Instalar depend√™ncias PHP (composer)
      run: composer install --no-dev --optimize-autoloader --no-interaction --no-progress

    - name: üì¶ Setup Node.js e compilar assets
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: üî® Compilar assets CSS/JS
      run: |
        npm ci
        npm run build

    - name: üì§ Enviar arquivos via FTP (incluindo vendor/)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        local-dir: ./
        server-dir: ${{ secrets.REMOTE_PATH }}/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env
          **/.env-*
          **/storage/logs/**
          **/storage/framework/cache/**
          **/storage/framework/sessions/**
          **/storage/framework/views/**

    - name: ‚ö° Rodar artisan via rota de setup
      env:
        SITE_URL: https://iagus.com.br
      run: |
        echo "Aguardando servidor processar arquivos..."
        sleep 10
        echo "Rodando migrations e otimiza√ß√µes..."
        RESP=$(curl -sk --max-time 120 "$SITE_URL/setup-iagus-2026?token=IAGUS_SETUP_KEY")
        echo "$RESP"
        if echo "$RESP" | grep -qi "sucesso\|success\|completed\|migrate"; then
          echo "‚úÖ Setup conclu√≠do!"
        else
          echo "‚ö†Ô∏è Verifique manualmente: $SITE_URL/setup-iagus-2026?token=IAGUS_SETUP_KEY"
        fi
