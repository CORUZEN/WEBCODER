name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necessÃ¡rios (apenas 4):
#   FTP_SERVER   â†’ 69.6.249.117
#   FTP_USERNAME â†’ abdonc73
#   FTP_PASSWORD â†’ senha principal do cPanel
#   REMOTE_PATH  â†’ /home1/abdonc73/iagus.com.br

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”¨ Instalar dependÃªncias e compilar assets
      run: |
        npm ci
        npm run build

    - name: ðŸ“‚ Deploy apenas arquivos alterados via SFTP (porta 2222)
      env:
        FTP_USER: ${{ secrets.FTP_USERNAME }}
        FTP_PASS: ${{ secrets.FTP_PASSWORD }}
        FTP_HOST: ${{ secrets.FTP_SERVER }}
        REMOTE: ${{ secrets.REMOTE_PATH }}
      run: |
        sudo apt-get install -y lftp -qq

        # Arquivos alterados no Ãºltimo commit (excluindo pastas sensÃ­veis)
        git diff --name-only HEAD~1 HEAD | grep -vE '^(\.git|\.github|node_modules|\.env|storage/logs|storage/framework/(cache|sessions|views))' > /tmp/changed_files.txt

        # Se assets foram alterados, incluir public/build
        if git diff --name-only HEAD~1 HEAD | grep -qE '^(resources/|vite\.config|tailwind|package\.)'; then
          find public/build -type f >> /tmp/changed_files.txt
        fi

        if [ ! -s /tmp/changed_files.txt ]; then
          echo "âœ… Nenhum arquivo alterado. Deploy ignorado."
          exit 0
        fi

        echo "ðŸ“¦ Arquivos para deploy:"
        cat /tmp/changed_files.txt

        # Gerar comandos lftp
        echo "set sftp:auto-confirm yes" > /tmp/lftp_cmds.txt
        echo "set net:timeout 30" >> /tmp/lftp_cmds.txt
        echo "open -u \"$FTP_USER\",\"$FTP_PASS\" sftp://$FTP_HOST:2222" >> /tmp/lftp_cmds.txt

        while IFS= read -r file; do
          [ -f "$file" ] || continue
          dir=$(dirname "$file")
          echo "mkdir -p $REMOTE/$dir" >> /tmp/lftp_cmds.txt
          echo "put $file -o $REMOTE/$file" >> /tmp/lftp_cmds.txt
        done < /tmp/changed_files.txt

        echo "bye" >> /tmp/lftp_cmds.txt

        lftp -f /tmp/lftp_cmds.txt
        echo "âœ… Deploy concluÃ­do!"

    - name: ðŸš€ PÃ³s-deploy via SSH (composer, migrate, optimize)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 2222
        script: |
          cd ${{ secrets.REMOTE_PATH }}
          rm -rf .git .github node_modules
          [ -f .env ] || cp .env-HOSTGATOR .env
          /usr/local/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction
          /usr/local/bin/php artisan migrate --force
          /usr/local/bin/php artisan optimize:clear
          /usr/local/bin/php artisan optimize
          /usr/local/bin/php artisan storage:link --relative 2>/dev/null || true
          chmod -R 775 storage bootstrap/cache
          echo "âœ… Deploy concluÃ­do!"
