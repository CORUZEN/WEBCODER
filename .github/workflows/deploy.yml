name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necessÃ¡rios (apenas 4):
#   FTP_SERVER   â†’ 69.6.249.117
#   FTP_USERNAME â†’ abdonc73
#   FTP_PASSWORD â†’ senha principal do cPanel
#   REMOTE_PATH  â†’ /home1/abdonc73/iagus.com.br

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”¨ Instalar dependÃªncias e compilar assets
      run: |
        npm ci
        npm run build

    - name: ðŸ“‚ Deploy via SFTP com lftp (porta 2222)
      run: |
        sudo apt-get install -y lftp
        lftp -u "${{ secrets.FTP_USERNAME }}","${{ secrets.FTP_PASSWORD }}" sftp://${{ secrets.FTP_SERVER }}:2222 <<'LFTP'
        set sftp:auto-confirm yes
        set net:timeout 30
        set net:max-retries 3
        mirror --reverse --verbose \
          --exclude-glob .git/ \
          --exclude-glob .github/ \
          --exclude-glob node_modules/ \
          --exclude-glob .env \
          --exclude-glob storage/logs/ \
          --exclude-glob storage/framework/cache/ \
          --exclude-glob storage/framework/sessions/ \
          --exclude-glob storage/framework/views/ \
          ./ ${{ secrets.REMOTE_PATH }}/
        LFTP

    - name: ðŸš€ PÃ³s-deploy via SSH (composer, migrate, optimize)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 2222
        script: |
          cd ${{ secrets.REMOTE_PATH }}
          rm -rf .git .github node_modules
          [ -f .env ] || cp .env-HOSTGATOR .env
          /usr/local/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction
          /usr/local/bin/php artisan migrate --force
          /usr/local/bin/php artisan optimize:clear
          /usr/local/bin/php artisan optimize
          /usr/local/bin/php artisan storage:link --relative 2>/dev/null || true
          chmod -R 775 storage bootstrap/cache
          echo "âœ… Deploy concluÃ­do!"
