name: Deploy para HostGator

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

# Secrets necessÃ¡rios:
#   FTP_SERVER   â†’ ftp.abdoncordeirodeliman1769452774835.1202135.meusitehostgator.com.br
#   FTP_USERNAME â†’ deploy@iagus.com.br
#   FTP_PASSWORD â†’ senha do usuÃ¡rio deploy
#   SSH_HOST     â†’ 69.6.249.117
#   SSH_USERNAME â†’ abdonc73
#   SSH_PASSWORD â†’ senha principal do cPanel
#   REMOTE_PATH  â†’ /home1/abdonc73/iagus.com.br

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸšš Checkout code
      uses: actions/checkout@v4

    - name: ðŸ“¦ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: ðŸ”¨ Instalar dependÃªncias e compilar assets
      run: |
        npm ci
        npm run build

    - name: ðŸ“‚ Deploy via FTP (porta 21)
      uses: SamKirkland/FTP-Deploy-Action@v4.3.5
      with:
        server: ${{ secrets.FTP_SERVER }}
        username: ${{ secrets.FTP_USERNAME }}
        password: ${{ secrets.FTP_PASSWORD }}
        port: 21
        protocol: ftp
        local-dir: ./
        server-dir: /
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.env
          **/storage/logs/**
          **/storage/framework/cache/**
          **/storage/framework/sessions/**
          **/storage/framework/views/**

    - name: ðŸš€ PÃ³s-deploy via SSH (composer, migrate, optimize)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.SSH_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        password: ${{ secrets.SSH_PASSWORD }}
        port: 2222
        script: |
          cd ${{ secrets.REMOTE_PATH }}
          /usr/local/bin/php /usr/local/bin/composer install --no-dev --optimize-autoloader --no-interaction
          /usr/local/bin/php artisan migrate --force
          /usr/local/bin/php artisan optimize:clear
          /usr/local/bin/php artisan optimize
          /usr/local/bin/php artisan storage:link --relative 2>/dev/null || true
          chmod -R 775 storage bootstrap/cache
          echo "âœ… Deploy concluÃ­do!"
